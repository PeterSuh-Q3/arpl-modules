# Copyright (C) 2022 Ing
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
# 소스 경로 수정 버전

name: Build modules (chroot)

on:
  workflow_dispatch:

env:
  # KERNEL_VERSION을 Matrix나 입력 파라미터로 정의하세요.
  KVER: "5.10.55"

jobs:
  build:
    container: ghcr.io/petersuh-q3/arpl-modules-multi:7.2-v1000nk  
    runs-on: ubuntu-latest    
    strategy:
      matrix:
        include:
          - version: "7.2"
            platform: v1000nk
            
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Init Env
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Seoul"

      - name: Prepare Source
        run: |
          MAJOR=$(echo "${KVER}" | cut -d. -f1)
          mkdir -p source/input source/output
          cp -a src/${MAJOR}.x/* source/input/

      - name: Build Modules inside Chroot
        run: |
          # chroot 내부에서 빌드
          sudo chroot /opt/build_env/ds.${{ matrix.platform }}-${{ matrix.version }} /bin/bash -eux << 'EOF'
            cd /source/input
            make -j"$(nproc)" M="$(pwd)" modules
            # 모듈 스트립 및 출력 디렉터리로 복사
            find . -name '*.ko' -exec strip -g {} \; -exec cp {} /source/output/ \;
          EOF

          # chroot 외부의 source/output 로 복사 (컨테이너 내부 경로)
          sudo cp -a /opt/build_env/ds.${{ matrix.platform }}-${{ matrix.version }}/source/output/. source/output/
          sudo chmod -R a+rw source/output/

      - name: Package Artifacts
        run: |
          if [ -n "$(ls -A source/output 2>/dev/null)" ]; then
            tar caf source/${{ matrix.platform }}-${{ env.KVER }}.tgz -C source/output .
          else
            echo "No modules built, skipping archival."
          fi

      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: modules
          path: source/*.tgz
          if-no-files-found: warn
